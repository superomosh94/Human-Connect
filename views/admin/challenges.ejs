<%- include('../partials/header') %>

    <div class="container dashboard-container py-4">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="mb-1">Mission <span class="highlight">Control</span></h2>
                <p class="text-muted">Manage active challenges and rewards for the explorer community.</p>
            </div>
            <button class="btn btn-primary d-flex align-items-center gap-2" onclick="openChallengeModal()">
                <i class="fa-solid fa-plus"></i> New Mission
            </button>
        </div>

        <div class="row">
            <% if (challenges.length===0) { %>
                <div class="col-12 text-center py-5">
                    <p class="text-muted">No missions found. Create your first challenge!</p>
                </div>
                <% } %>
                    <% challenges.forEach(c=> { %>
                        <div class="col-md-6 mb-4" id="challenge-card-<%= c.id %>">
                            <div class="feature-card h-100 <%= c.is_active ? 'border-primary' : 'opacity-50' %>"
                                style="border-left: 4px solid <%= c.is_active ? 'var(--primary)' : 'var(--border)' %>">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <span class="badge <%= c.is_active ? 'badge-primary' : 'bg-dark' %>">
                                        <%= c.is_active ? 'ACTIVE' : 'INACTIVE' %>
                                    </span>
                                    <div class="d-flex gap-2">
                                        <button class="icon-btn text-muted"
                                            onclick='openChallengeModal(<%- JSON.stringify(c) %>)'><i
                                                class="fa-solid fa-pen-to-square"></i></button>
                                        <button class="icon-btn text-error" onclick="deleteChallenge(<%= c.id %>)"><i
                                                class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                                <h4 class="mb-2">
                                    <%= c.title %>
                                </h4>
                                <p class="text-muted small mb-4">
                                    <%= c.description %>
                                </p>

                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Target</small>
                                        <strong>
                                            <%= c.goal_count %>
                                                <%= c.goal_type %>s
                                        </strong>
                                    </div>
                                    <div class="col-6 text-end">
                                        <small class="text-muted d-block">Reward</small>
                                        <strong class="text-gold">+<%= c.xp_reward %> XP</strong>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between align-items-center mt-auto pt-3 border-top"
                                    style="border-color: var(--border) !important;">
                                    <span class="small text-muted"><i class="fa-solid fa-calendar mr-1"></i>
                                        <%= new Date(c.start_date).toLocaleDateString() %> - <%= new
                                                Date(c.end_date).toLocaleDateString() %>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <% }) %>
        </div>
    </div>

    <!-- Challenge Modal -->
    <div id="challengeModal" class="modal-overlay" style="display: none;">
        <div class="modal-content feature-card" style="max-width: 550px; margin: 50px auto;">
            <h3 id="modalTitle" class="mb-4">Configure <span class="highlight">Mission</span></h3>
            <form id="challengeForm">
                <input type="hidden" id="challengeId">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label small text-muted">Title</label>
                        <input type="text" id="cTitle" class="form-control" required>
                    </div>
                    <div class="col-md-12 mb-3">
                        <label class="form-label small text-muted">Description</label>
                        <textarea id="cDescription" class="form-control" rows="2" required></textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label small text-muted">Goal Type</label>
                        <select id="cType" class="form-control">
                            <option value="simulation">Simulations</option>
                            <option value="drill">Drills</option>
                            <option value="journal">Journals</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label small text-muted">Goal Count</label>
                        <input type="number" id="cCount" class="form-control" min="1" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label small text-muted">XP Reward</label>
                        <input type="number" id="cReward" class="form-control" min="50" step="50" value="150" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label small text-muted">Status</label>
                        <select id="cActive" class="form-control">
                            <option value="1">Active</option>
                            <option value="0">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label small text-muted">Start Date</label>
                        <input type="date" id="cStart" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label small text-muted">End Date</label>
                        <input type="date" id="cEnd" class="form-control" required>
                    </div>
                </div>
                <div class="d-flex gap-3 mt-4">
                    <button type="button" class="btn btn-outline flex-grow-1"
                        onclick="closeChallengeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary flex-grow-1">Save Mission</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .icon-btn:hover {
            transform: scale(1.15);
        }

        .text-error {
            color: var(--error);
        }

        .opacity-50 {
            opacity: 0.5;
        }
    </style>

    <script>
        function openChallengeModal(c = null) {
            const modal = document.getElementById('challengeModal');
            document.getElementById('challengeForm').reset();
            document.getElementById('challengeId').value = c ? c.id : '';
            if (c) {
                document.getElementById('cTitle').value = c.title;
                document.getElementById('cDescription').value = c.description;
                document.getElementById('cType').value = c.goal_type;
                document.getElementById('cCount').value = c.goal_count;
                document.getElementById('cReward').value = c.xp_reward;
                document.getElementById('cActive').value = c.is_active ? '1' : '0';
                document.getElementById('cStart').value = new Date(c.start_date).toISOString().split('T')[0];
                document.getElementById('cEnd').value = new Date(c.end_date).toISOString().split('T')[0];
            } else {
                // Default dates: Today to 7 days from now
                const now = new Date();
                const week = new Date(); week.setDate(now.getDate() + 7);
                document.getElementById('cStart').value = now.toISOString().split('T')[0];
                document.getElementById('cEnd').value = week.toISOString().split('T')[0];
            }
            modal.style.display = 'block';
        }

        function closeChallengeModal() {
            document.getElementById('challengeModal').style.display = 'none';
        }

        document.getElementById('challengeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('challengeId').value;
            const data = {
                id: id,
                title: document.getElementById('cTitle').value,
                description: document.getElementById('cDescription').value,
                goal_type: document.getElementById('cType').value,
                goal_count: document.getElementById('cCount').value,
                xp_reward: document.getElementById('cReward').value,
                is_active: document.getElementById('cActive').value === '1',
                start_date: document.getElementById('cStart').value,
                end_date: document.getElementById('cEnd').value
            };

            const url = '/admin/challenges';
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) location.reload();
                else alert('Error: ' + result.error);
            } catch (err) {
                console.error(err);
            }
        });

        async function deleteChallenge(id) {
            if (!confirm('Delete this mission permanently?')) return;
            try {
                const res = await fetch(`/admin/challenges/${id}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) document.getElementById(`challenge-card-${id}`).remove();
                else alert('Error deleting mission.');
            } catch (err) { console.error(err); }
        }
    </script>

    <%- include('../partials/footer') %>