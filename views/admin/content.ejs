<%- include('../partials/header') %>

    <div class="container dashboard-container py-4">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="mb-1">Tool <span class="highlight">Repository</span></h2>
                <p class="text-muted">Configure conversation techniques and training exercises.</p>
            </div>
            <button class="btn btn-primary d-flex align-items-center gap-2" onclick="openToolModal()">
                <i class="fa-solid fa-plus"></i> Add New Tool
            </button>
        </div>

        <div class="row">
            <% if (tools.length===0) { %>
                <div class="col-12 text-center py-5">
                    <p class="text-muted">No tools found. Start by adding one!</p>
                </div>
                <% } %>
                    <% tools.forEach(tool=> { %>
                        <div class="col-md-6 mb-4" id="tool-card-<%= tool.id %>">
                            <div class="feature-card h-100">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <span class="badge"
                                        style="background: rgba(255,255,255,0.05); color: var(--text-muted); padding: 5px 12px; border: 1px solid var(--border);">
                                        <%= tool.tool_type.replace('_', ' ' ) %>
                                    </span>
                                    <div class="d-flex gap-2">
                                        <button class="icon-btn text-muted"
                                            onclick="openToolModal(<%= JSON.stringify(tool) %>)"><i
                                                class="fa-solid fa-pen-to-square"></i></button>
                                        <button class="icon-btn text-error" onclick="deleteTool(<%= tool.id %>)"><i
                                                class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                                <h4 class="mb-2">
                                    <%= tool.tool_name %>
                                </h4>
                                <p class="text-muted small mb-4">
                                    <%= tool.description %>
                                </p>

                                <div class="p-3 rounded bg-dark mb-3">
                                    <code class="text-primary font-weight-bold"><%= tool.formula %></code>
                                </div>

                                <div class="d-flex justify-content-between align-items-center mt-auto pt-3 border-top"
                                    style="border-color: var(--border) !important;">
                                    <span class="small text-muted">Difficulty:
                                        <span class="text-gold">
                                            <%= '●' .repeat(tool.difficulty_level) %>
                                                <%= '○' .repeat(5 - tool.difficulty_level) %>
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <% }) %>
        </div>
    </div>

    <!-- Tool Modal -->
    <div id="toolModal" class="modal-overlay" style="display: none;">
        <div class="modal-content feature-card" style="max-width: 500px; margin: 50px auto;">
            <h3 id="modalTitle" class="mb-4">Add <span class="highlight">New Tool</span></h3>
            <form id="toolForm">
                <input type="hidden" id="toolId">
                <div class="mb-3">
                    <label class="form-label small text-muted">Tool Name</label>
                    <input type="text" id="toolName" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Type</label>
                    <select id="toolType" class="form-control">
                        <option value="Discovery">Discovery</option>
                        <option value="Active_Listening">Active Listening</option>
                        <option value="Shared_Reality">Shared Reality</option>
                        <option value="Advanced">Advanced</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Description</label>
                    <textarea id="toolDescription" class="form-control" rows="3" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Formula/Key Phrase</label>
                    <input type="text" id="toolFormula" class="form-control"
                        placeholder="e.g. Observation + Open Question" required>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Difficulty (1-5)</label>
                    <input type="number" id="toolDifficulty" class="form-control" min="1" max="5" value="1" required>
                </div>
                <div class="d-flex gap-3 mt-4">
                    <button type="button" class="btn btn-outline flex-grow-1" onclick="closeToolModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary flex-grow-1">Save Tool</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .icon-btn:hover {
            transform: scale(1.15);
        }

        .text-error {
            color: var(--error);
        }

        .bg-dark {
            background: rgba(0, 0, 0, 0.2) !important;
        }
    </style>

    <script>
        function openToolModal(tool = null) {
            const modal = document.getElementById('toolModal');
            document.getElementById('toolForm').reset();
            document.getElementById('toolId').value = tool ? tool.id : '';
            if (tool) {
                document.getElementById('modalTitle').innerHTML = 'Edit <span class="highlight">Tool</span>';
                document.getElementById('toolName').value = tool.tool_name;
                document.getElementById('toolType').value = tool.tool_type;
                document.getElementById('toolDescription').value = tool.description;
                document.getElementById('toolFormula').value = tool.formula;
                document.getElementById('toolDifficulty').value = tool.difficulty_level;
            } else {
                document.getElementById('modalTitle').innerHTML = 'Add <span class="highlight">New Tool</span>';
            }
            modal.style.display = 'block';
        }

        function closeToolModal() {
            document.getElementById('toolModal').style.display = 'none';
        }

        document.getElementById('toolForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('toolId').value;
            const data = {
                id: id,
                tool_name: document.getElementById('toolName').value,
                tool_type: document.getElementById('toolType').value,
                description: document.getElementById('toolDescription').value,
                formula: document.getElementById('toolFormula').value,
                difficulty_level: document.getElementById('toolDifficulty').value
            };

            const url = '/admin/content/tools';
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                console.error(err);
                alert('An error occurred. Check console.');
            }
        });

        async function deleteTool(id) {
            if (!confirm('Are you sure you want to delete this tool?')) return;
            try {
                const res = await fetch(`/admin/content/tools/${id}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    document.getElementById(`tool-card-${id}`).remove();
                } else {
                    alert('Error deleting tool.');
                }
            } catch (err) {
                console.error(err);
            }
        }
    </script>

    <%- include('../partials/footer') %>